-- add hook {{name}}
DO $$
DECLARE
  v_projection_id INTEGER;
BEGIN
  {{#if (eq event 'ADD_CHANGE_SET')}}
  {{#if (and projection version)}}
  SELECT id INTO v_projection_id
  FROM fby_projection
  WHERE name = '{{projection}}'
    AND version = {{version}};
  {{/if}}
  {{/if}}

  BEGIN
    INSERT INTO fby_hook (name, event, projection_id) VALUES ('{{name}}', '{{event}}', v_projection_id);
  EXCEPTION
    WHEN unique_violation
    THEN RAISE EXCEPTION 'Hook ''{{name}}'' already exists';
  END;
END;
$$ LANGUAGE plpgsql;
