-- add projection {{name}} v{{version}}
DO $$
DECLARE
  v_projection_id INTEGER;
  v_entity_id INTEGER;
BEGIN
  BEGIN
    INSERT INTO fby_projection (name, version) VALUES
    ('{{name}}', {{version}})
    RETURNING id INTO v_projection_id;
  EXCEPTION
    WHEN unique_violation
    THEN RAISE EXCEPTION 'Projection ''{{name}} v{{version}}'' already exists';
  END;

  {{#dependencies}}
  SELECT id INTO v_entity_id
  FROM fby_entity
  WHERE name = '{{entity}}'
    AND version = {{version}};

  INSERT INTO fby_projection_entity (projection_id, entity_id) VALUES
  (v_projection_id, v_entity_id);
  {{/dependencies}}
END;
$$ LANGUAGE plpgsql;
